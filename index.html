<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>お世話ゲーム（3日間）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {
    margin: 0;
    font-family: system-ui, -apple-system, "Yu Gothic", "Meiryo", sans-serif;
    background: #f4f5f8;
    color: #222;
    text-align: center;
  }
  .container {
    max-width: 420px;
    margin: 0 auto;
    padding: 16px;
  }
  #character {
    width: 200px;
    height: 200px;
    margin: 24px auto;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    transition: transform 1s ease, opacity 1s ease;
  }
  .float {
    animation: float 3s infinite ease-in-out;
  }
  @keyframes float {
    0% { transform: translateY(0); }
    50% { transform: translateY(-12px); }
    100% { transform: translateY(0); }
  }
  .buttons button {
    margin: 6px;
    padding: 10px 14px;
    font-size: 14px;
  }
  .hidden {
    display: none;
  }
  #ending {
    font-size: 28px;
    margin-top: 120px;
  }
  #logView {
    text-align: left;
    font-size: 12px;
    margin-top: 24px;
    white-space: pre-wrap;
  }
</style>
</head>
<body>
<div class="container">
  <div id="character"></div>

  <div class="buttons" id="actions">
    <button onclick="care('meal','light')">軽い食事</button>
    <button onclick="care('meal','heavy')">しっかりした食事</button>
    <button onclick="care('out','go')">外に出る</button>
    <button onclick="care('out','stay')">家で過ごす</button>
    <button onclick="care('mini','A')">ミニゲーム A</button>
    <button onclick="care('mini','B')">ミニゲーム B</button>
    <button onclick="clean()">排泄を片付ける</button>
    <button onclick="toggleSitter()">シッター</button>
    <button onclick="useDrink()">ドリンク</button>
    <button onclick="useMacaron()">マカロン</button>
  </div>

  <div id="ending" class="hidden">ありがとう</div>
  <div id="logView" class="hidden"></div>
</div>

<script>
/*
  ========= 基本設定 =========
*/
const LIFE_SPAN = 3 * 24 * 60 * 60 * 1000; // 3日
const EGG_TIME = 3 * 60 * 1000; // 3分

const STORAGE_KEY = "care_game_data";

/*
  ========= 初期化 =========
*/
let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || initData();
let now = Date.now();

function initData() {
  const id = Math.random().toString(36).slice(2);
  return {
    id,
    startTime: Date.now(),
    birthTime: null,
    deathTime: null,
    hearts: 5,
    state: "egg", // egg / alive / dead
    mood: 0, // -2〜2
    poop: 0,
    sitter: { on:false, used:0, last:null },
    revive: { macaron:0, drink:0 },
    logs: {}
  };
}

/*
  ========= 表示更新 =========
*/
function updateCharacter() {
  const el = document.getElementById("character");

  if (data.state === "egg") {
    el.style.backgroundImage = "url(public/char/egg.png)";
  } else if (data.state === "alive") {
    // 気分によって画像を変える（後で差し替え）
    if (data.mood >= 1) {
      el.style.backgroundImage = "url(public/char/happy.png)";
      el.classList.add("float");
    } else if (data.mood <= -1) {
      el.style.backgroundImage = "url(public/char/sad.png)";
      el.classList.remove("float");
    } else {
      el.style.backgroundImage = "url(public/char/normal.png)";
      el.classList.remove("float");
    }
  } else {
    el.style.backgroundImage = "url(public/char/dead.png)";
    el.classList.remove("float");
  }
}

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

/*
  ========= 時間進行 =========
*/
function tick() {
  if (data.sitter.on) return;

  const t = Date.now();

  // 誕生
  if (!data.birthTime && t - data.startTime >= EGG_TIME) {
    data.birthTime = t;
    data.state = "alive";
  }

  // 排泄放置
  if (data.state === "alive") {
    data.poop += 0.01;
    if (data.poop > 5) {
      data.mood -= 0.01;
    }
  }

  // 死亡
  if (data.state === "alive" && t - data.startTime >= LIFE_SPAN) {
    data.state = "dead";
    data.deathTime = t;
    endGame();
  }

  save();
  updateCharacter();
}

setInterval(tick, 1000);

/*
  ========= お世話 =========
*/
function care(type, choice) {
  if (data.state !== "alive") return;

  data.hearts += Math.random() > 0.5 ? 1 : -1;
  data.mood += Math.random() > 0.5 ? 1 : -1;

  log(type, choice);
  save();
  updateCharacter();
}

function clean() {
  if (data.state !== "alive") return;
  data.poop = Math.max(0, data.poop - 3);
  data.mood += 0.5;
  log("clean","done");
  save();
}

function toggleSitter() {
  if (!data.sitter.on) {
    data.sitter.on = true;
    data.sitter.last = Date.now();
  } else {
    data.sitter.on = false;
    data.sitter.used += Date.now() - data.sitter.last;
  }
  log("sitter", data.sitter.on ? "on" : "off");
  save();
}

function useDrink() {
  if (data.state !== "alive") return;
  data.mood += 1;
  data.hearts += 1;
  data.revive.drink++;
  log("drink","use");
  save();
}

function useMacaron() {
  if (data.state !== "dead") return;
  data.state = "alive";
  data.mood = -1; // 違和感のある復活
  data.revive.macaron++;
  log("macaron","revive");
  save();
}

/*
  ========= ログ =========
*/
function log(type, value) {
  const day = Math.floor((Date.now() - data.startTime) / (24*60*60*1000)) + 1;
  if (!data.logs[day]) data.logs[day] = [];
  data.logs[day].push({
    time: new Date().toLocaleString(),
    type,
    value,
    hearts: data.hearts
  });
}

/*
  ========= エンディング =========
*/
function endGame() {
  document.getElementById("actions").classList.add("hidden");
  document.getElementById("ending").classList.remove("hidden");
  setTimeout(showLogs, 3000);
}

function showLogs() {
  const el = document.getElementById("logView");
  el.classList.remove("hidden");
  el.textContent = JSON.stringify(data.logs, null, 2);
}

/*
  ========= 初回描画 =========
*/
updateCharacter();
</script>
</body>
</html>
